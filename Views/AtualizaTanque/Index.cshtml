@using SEDOGv2.Helpers;
@using SEDOGv2.Models;


@{
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_LoggedIn.cshtml";
}


<div class="container-fluid">
    <div class="panel panel-success">
        <!-- Default panel contents -->
        <div class="row">
            <div class="panel-heading  text-center">
                <h2>
                    @appSettings.pageName()
                </h2>
                @ViewBag.Error
            </div>
        </div>

        @using (Html.BeginForm("UpdateTanqueAll", "AtualizaTanque"))
            {


            <div class="row noBg">
                <div class="">
                    <div class="itm">
                        <div class="detalhesBody">
                            <h4 data-toggle="collapse" data-target="#lsResposanveisDepartamento" class="clickRotateIcon">Update Gaugue:<i class="fa fa-arrow-circle-down pull-right rotate"></i></h4>
                            <div id="lsResposanveisDepartamento" class="collapse out" style="padding-left:5px;padding-right:5px;padding-bottom:5px;">




                                <div class="col-md-2 text-right">
                                    <div class="form-group">
                                        <label style="font-size:18px; font-weight: bold;">Month:</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <select class="form-control" name="mesALL" id="mesALL">
                                            <option value="1" @(DateTime.Now.Month == 1 ? "selected" : "")>January</option>
                                            <option value="2" @(DateTime.Now.Month == 2 ? "selected" : "")>February</option>
                                            <option value="3" @(DateTime.Now.Month == 3 ? "selected" : "")>March</option>
                                            <option value="4" @(DateTime.Now.Month == 4 ? "selected" : "")>April</option>
                                            <option value="5" @(DateTime.Now.Month == 5 ? "selected" : "")>May</option>
                                            <option value="6" @(DateTime.Now.Month == 6 ? "selected" : "")>June</option>
                                            <option value="7" @(DateTime.Now.Month == 7 ? "selected" : "")>July</option>
                                            <option value="8" @(DateTime.Now.Month == 8 ? "selected" : "")>August</option>
                                            <option value="9" @(DateTime.Now.Month == 9 ? "selected" : "")>September</option>
                                            <option value="10" @(DateTime.Now.Month == 10 ? "selected" : "")>October</option>
                                            <option value="11" @(DateTime.Now.Month == 11 ? "selected" : "")>November</option>
                                            <option value="12" @(DateTime.Now.Month == 12 ? "selected" : "")>December</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-2 text-right">
                                    <div class="form-group">
                                        <label style="font-size:18px; font-weight: bold;">Year:</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <input type="number" class="form-control" name="anoALL" id="anoALL" value="@DateTime.Now.Year" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <input type="submit" name="Atualizar" value="Update" class="btn btn-default btn-lg" />
                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }


        @using (Html.BeginForm("UpdateForcast", "AtualizaTanque"))
            {


            <div class="row noBg">
                <div class="">
                    <div class="itm">
                        <div class="detalhesBody">
                            <h4 data-toggle="collapse" data-target="#lsAtualizarForcast" class="clickRotateIcon">Update Forcast<i class="fa fa-arrow-circle-down pull-right rotate"></i></h4>
                            <div id="lsAtualizarForcast" class="collapse out" style="padding-left:5px;padding-right:5px;padding-bottom:5px;">



                                <div class="col-md-2 text-right">
                                    <div class="form-group">
                                        <label style="font-size:18px; font-weight: bold;">Gaugue Type:</label>
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        <select class="form-control" name="nomeForcast" id="nomeForcast">
                                            <option value=""> -- Todos -- </option>
                                            @foreach (CamposTanqueViewModel item in Model)
                                            {
                                                <option value="@item.NOME">@item.NOME</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-2 text-right">
                                    <div class="form-group">
                                        <label style="font-size:18px; font-weight: bold;">Month:</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <select class="form-control" name="mesForcast" id="mesForcast">
                                            <option value="2" @(DateTime.Now.Month == 2 ? "selected" : "")>February</option>
                                            <option value="5" @(DateTime.Now.Month == 5 ? "selected" : "")>May</option>
                                            <option value="9" @(DateTime.Now.Month == 9 ? "selected" : "")>September</option>
                                            <option value="11" @(DateTime.Now.Month == 11 ? "selected" : "")>November</option>
                                        </select>
                                    </div>
                                </div>


                                <div class="col-md-2">
                                    <div class="form-group">
                                        <input type="submit" name="Atualizar" value="Update" class="btn btn-default btn-lg" />
                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }



        <div class="row">

            @using (Html.BeginForm())
            {

                <div class="col-md-2 text-right">
                    <div class="form-group">
                        <h4>Gaugue Type:</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <select class="form-control" name="nome" id="nome">
                            @foreach (CamposTanqueViewModel item in Model)
                            {
                                <option value="@item.NOME" @(item.NOME == ViewBag.TipoTanque ? "selected" : "")>@item.NOME</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2 text-right">
                    <div class="form-group">
                        <h4>Year:</h4>
                    </div>
                </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <input type="number" class="form-control" name="ano" id="ano" value="@DateTime.Now.Year" />
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <input type="submit" name="Listar" value="Listar" class="btn btn-default btn-lg" />
                                            </div>
                                        </div>

            }
        </div>
        <div class="row">
            <div class="col-md-12">
                <table class="table table-hover table-bordered updateTotalTable">
                    <tr>
                        <th>Gaugue</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Real</th>
                        <th>Forecast</th>
                        <th>Plan</th>
                    </tr>
                    @foreach (ValoresTanqueViewModel item in ViewBag.ValoresTanque)
                    {
                        <tr class="saveLine">
                            <td class="nomeVal">@item.TANQUE</td>
                            <td class="anoVal">@item.ANO</td>
                            <td class="mesVal">@item.DESCMES</td>
                            <td><a href="#" class="editable realVal" data-type="text" data-placement="top" data-title="Type a value for field" data-emptytext="0">@item.REAL.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</a></td>
                            <td><a href="#" class="editable foreVal" data-type="text" data-placement="top" data-title="Type a value for field" data-emptytext="0">@item.FORE.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</a></td>
                            <td><a href="#" class="editable planVal" data-type="text" data-placement="top" data-title="Type a value for field" data-emptytext="0">@item.PLAN.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</a></td>
                        </tr>
                    }

                    @*@if (ViewBag.TipoTanque != "Digital Subscribers")*@
                    @*{*@
                        <tr>
                            <th colspan="3" class="text-right">Total:</th>
                            <th class="totalRealVal">@ViewBag.REAL.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</th>
                            <th class="totalForeVal">@ViewBag.FORE.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</th>
                            <th class="totaPlanVal">@ViewBag.PLAN.ToString("N0", System.Globalization.CultureInfo.CreateSpecificCulture(SEDOGv2.Helpers.appSettings._User.Culture))</th>
                        </tr>
                    @*}*@
                </table>
                <input type="button" id="btnUpdate" value="Update" class="btn btn-default pull-right hidden btnShowModal" />
            </div>
        </div>
    </div>



</div>
<script>

    Number.prototype.format = function () {
        return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    };

    $(".editable").editable().on('shown', function (e, editable) {
        editable.input.$input.val(editable.input.$input.val().replace(/[\.]+/g, '').replace(/[\,]+/g, ''))
        editable.input.$input.keydown(function (e) {
            if (e.key == ',' || e.key == '.') {
                e.preventDefault();
                //alert('Tecla inválida');
                return;
            }
            if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190, 109, 189]) !== -1 ||
                (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                return;
            }
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
    }).on('hidden', function (e, reason) {
        var totalRealVal = 0;
        var totalForeVal = 0;
        var totalPlanVal = 0;


        $('.updateTotalTable .saveLine').each(function (i, e) {
            totalRealVal += Number($(this).find('.realVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, ''));
            totalForeVal += Number($(this).find('.foreVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, ''));
            totalPlanVal += Number($(this).find('.planVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, ''));
        });
        $('.updateTotalTable .totalRealVal').html(totalRealVal.format());
        $('.updateTotalTable .totalForeVal').html(totalForeVal.format());
        $('.updateTotalTable .totalPlanVal').html(totalPlanVal.format());
        if (reason === 'save') {
            $('#btnUpdate').removeClass('hidden');
        }
    });

    $('#btnUpdate').click(function () {
        var linhas = [];
        $('.updateTotalTable .saveLine').each(function (i, e) {
            var linha =
                        {
                            TANQUE: $(this).find('.nomeVal').html(),
                            ANO: $(this).find('.anoVal').html(),
                            DESCMES: $(this).find('.mesVal').html(),
                            REAL: Number($(this).find('.realVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, '')),
                            PLAN: Number($(this).find('.planVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, '')),
                            FORE: Number($(this).find('.foreVal').html().replace(/[\.]+/g, '').replace(/[\,]+/g, ''))
                        };
            linhas.push(linha);
        });

        $.ajax({
            url: "AtualizaTanque/UpdateTanque",
            type: "POST",
            data: JSON.stringify({ 'valores': linhas }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                $('#pleaseWaitDialog .messageDialog').html(response.responseText);
                setTimeout(
                    function () {
                        $('#pleaseWaitDialog').modal('toggle');
                        $('#pleaseWaitDialog .messageDialog').html('');
                    }, 5000);
            },
            error: function (response) {
                $('#pleaseWaitDialog').modal('toggle');
                alert("Erro.");
            }
        });
    });

</script>
